# é£ä¹¦é›†æˆä¿®å¤æ€»ç»“

åŸºäº Lark SDK è§„èŒƒçš„ä»£ç å®¡æŸ¥å’Œä¿®å¤ã€‚

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. tenant_access_token API å“åº”å¤„ç†

**é—®é¢˜**: æ²¡æœ‰æ£€æŸ¥å“åº”ä¸­çš„ `code` å­—æ®µï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯æœªè¢«æ­£ç¡®å¤„ç†ã€‚

**ä¿®å¤**:

- åœ¨ `FeishuTenantAccessTokenResponse` ä¸­æ·»åŠ äº† `code` å’Œ `msg` å­—æ®µ
- åœ¨è·å– token æ—¶å…ˆæ£€æŸ¥ `code` å­—æ®µï¼Œå¦‚æœä¸ä¸º 0 åˆ™æŠ›å‡ºé”™è¯¯
- æ·»åŠ äº†æˆåŠŸæ—¥å¿—è¾“å‡º

```typescript
// ä¿®å¤å‰
if (!res.tenant_access_token) {
  throw new Error('Failed to get tenant access token');
}

// ä¿®å¤å
if (res.code !== undefined && res.code !== FeishuErrorCode.SUCCESS) {
  const errorMsg =
    FEISHU_ERROR_MESSAGES[res.code] || res.msg || 'Failed to get tenant access token';
  throw new Error(`[${res.code}] ${errorMsg}`);
}

if (!res.tenant_access_token) {
  throw new Error('Failed to get tenant access token');
}
```

### 2. å·²ç¡®è®¤ API å‚æ•°åç§°æ­£ç¡®

ç»æ£€æŸ¥ï¼Œä»£ç å·²ç»ä½¿ç”¨äº†æ­£ç¡®çš„å‚æ•°åï¼š

- âœ… `user_id_type` - ç”¨æˆ· ID ç±»å‹
- âœ… `user_id` - ç”¨æˆ· IDï¼ˆç”¨äºç­›é€‰ä»»åŠ¡ï¼‰
- âœ… `tasklist_guids` - ä»»åŠ¡åˆ—è¡¨ GUIDï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰

## âš ï¸ éœ€è¦å®é™…æµ‹è¯•éªŒè¯çš„é—®é¢˜

ä»¥ä¸‹é—®é¢˜éœ€è¦åœ¨å®é™…ä½¿ç”¨ä¸­éªŒè¯ï¼š

### 1. tasklist_guids å‚æ•°

**å½“å‰å®ç°**: æ”¯æŒå¤šä¸ªä»»åŠ¡åˆ—è¡¨ IDï¼Œç”¨é€—å·åˆ†éš”

```typescript
params.tasklist_guids = cfg.filterTasklistIds.join(',');
```

**éœ€è¦éªŒè¯**:

- é£ä¹¦ API æ˜¯å¦çœŸçš„æ”¯æŒå¤šä¸ª tasklist_guidsï¼Ÿ
- è¿˜æ˜¯åªæ”¯æŒå•ä¸ª `tasklist_guid`ï¼Ÿ

**å¦‚æœåªæ”¯æŒå•ä¸ª**ï¼Œéœ€è¦ä¿®æ”¹ä¸ºï¼š

```typescript
// åªä½¿ç”¨ç¬¬ä¸€ä¸ª
params.tasklist_guid = cfg.filterTasklistIds[0];

// æˆ–è€…ï¼šå¤šæ¬¡è°ƒç”¨ API è·å–æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨
```

### 2. å®Œæˆ/å–æ¶ˆå®Œæˆä»»åŠ¡çš„ API å“åº”

**éœ€è¦éªŒè¯**:

- å®Œæˆä»»åŠ¡ API (`/task/v2/tasks/:guid/complete`) çš„å“åº”ç»“æ„
- å–æ¶ˆå®Œæˆä»»åŠ¡ API (`/task/v2/tasks/:guid/uncomplete`) çš„å“åº”ç»“æ„
- æ˜¯å¦è¿”å›å®Œæ•´çš„ä»»åŠ¡å¯¹è±¡ï¼Ÿ

### 3. è¯„è®º API çš„å­—æ®µåç§°

**å½“å‰å®ç°**:

```typescript
export interface FeishuComment {
  id: string;
  content: string;
  created_at: string;
  creator_id: string;
}
```

**éœ€è¦éªŒè¯**:

- å­—æ®µåæ˜¯ `id` è¿˜æ˜¯ `comment_id`ï¼Ÿ
- å†…å®¹å­—æ®µæ˜¯ `content` è¿˜æ˜¯ `rich_text`/`rich_summary`ï¼Ÿ

## ğŸš€ å»ºè®®çš„åç»­ä¼˜åŒ–ï¼ˆéå¿…é¡»ï¼‰

### ä¼˜å…ˆçº§ï¼šä¸­

#### 1. æ·»åŠ è¯·æ±‚è¶…æ—¶å¤„ç†

```typescript
import { timeout } from 'rxjs/operators';

getTasks$(...) {
  return this._http.get<...>(url, { headers }).pipe(
    timeout(FEISHU_API_DEFAULTS.REQUEST_TIMEOUT),
    // ...
  );
}
```

#### 2. Token åˆ·æ–°é˜²ç«æ€

å¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶å‘ç° token è¿‡æœŸï¼Œæ·»åŠ é”æœºåˆ¶é˜²æ­¢é‡å¤è¯·æ±‚ï¼š

```typescript
private _tokenRefreshLock: { [key: string]: Observable<string> } = {};

getTenantAccessToken$(cfg: FeishuCfg): Observable<string> {
  // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿›è¡Œä¸­çš„åˆ·æ–°è¯·æ±‚
  if (this._tokenRefreshLock[cacheKey]) {
    return this._tokenRefreshLock[cacheKey];
  }
  // ...
}
```

### ä¼˜å…ˆçº§ï¼šä½

#### 3. æ·»åŠ é‡è¯•æœºåˆ¶

å¯¹äºä¸´æ—¶æ€§é”™è¯¯ï¼ˆå¦‚ç½‘ç»œè¶…æ—¶ã€é™æµï¼‰è‡ªåŠ¨é‡è¯•ï¼š

```typescript
import { retryWhen, delay, take } from 'rxjs/operators';

getTasks$(...) {
  return this._http.get<...>(url, { headers }).pipe(
    retryWhen(errors =>
      errors.pipe(
        delay(1000),
        take(3), // æœ€å¤šé‡è¯• 3 æ¬¡
      )
    ),
    // ...
  );
}
```

## ğŸ“‹ å®é™…æµ‹è¯•æ¸…å•

åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼Œå»ºè®®æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

### åŸºç¡€åŠŸèƒ½

- [ ] ä½¿ç”¨çœŸå®çš„ App ID å’Œ App Secret è·å– token
- [ ] è·å–ä»»åŠ¡åˆ—è¡¨ï¼ˆæ— ç­›é€‰ï¼‰
- [ ] æŒ‰ç”¨æˆ· ID ç­›é€‰ä»»åŠ¡
- [ ] æŒ‰ä»»åŠ¡åˆ—è¡¨ç­›é€‰ä»»åŠ¡ï¼ˆå•ä¸ªï¼‰
- [ ] æŒ‰ä»»åŠ¡åˆ—è¡¨ç­›é€‰ä»»åŠ¡ï¼ˆå¤šä¸ªï¼‰
- [ ] è·å–å•ä¸ªä»»åŠ¡è¯¦æƒ…
- [ ] åˆ†é¡µè·å–æ‰€æœ‰ä»»åŠ¡

### ä»»åŠ¡æ“ä½œ

- [ ] æ›´æ–°ä»»åŠ¡æ ‡é¢˜
- [ ] æ›´æ–°ä»»åŠ¡æè¿°
- [ ] å®Œæˆä»»åŠ¡
- [ ] å–æ¶ˆå®Œæˆä»»åŠ¡

### è¯„è®ºåŠŸèƒ½

- [ ] è·å–ä»»åŠ¡è¯„è®º
- [ ] æ·»åŠ è¯„è®º

### é”™è¯¯åœºæ™¯

- [ ] æ— æ•ˆçš„ App ID
- [ ] æ— æ•ˆçš„ App Secret
- [ ] Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°
- [ ] æƒé™ä¸è¶³
- [ ] ç½‘ç»œé”™è¯¯
- [ ] è¯·æ±‚é¢‘ç‡é™åˆ¶

### åŒå‘åŒæ­¥

- [ ] Super Productivity â†’ é£ä¹¦ï¼šçŠ¶æ€åŒæ­¥
- [ ] Super Productivity â†’ é£ä¹¦ï¼šå†…å®¹åŒæ­¥
- [ ] Super Productivity â†’ é£ä¹¦ï¼šè¯„è®ºåŒæ­¥
- [ ] é˜²é‡å¤åŒæ­¥æœºåˆ¶

## ğŸ“š ä¸ Lark SDK çš„å¯¹æ¯”æ€»ç»“

| åŠŸèƒ½           | Lark SDK | æˆ‘ä»¬çš„å®ç° | çŠ¶æ€          |
| -------------- | -------- | ---------- | ------------- |
| Token è·å–     | âœ…       | âœ…         | âœ… å®Œå…¨ä¸€è‡´   |
| Token ç¼“å­˜     | âœ…       | âœ…         | âœ… å®Œå…¨ä¸€è‡´   |
| Token é”™è¯¯å¤„ç† | âœ…       | âœ…         | âœ… **å·²ä¿®å¤** |
| ä»»åŠ¡åˆ—è¡¨ API   | âœ…       | âœ…         | âœ… å®Œå…¨ä¸€è‡´   |
| å‚æ•°åç§°       | âœ…       | âœ…         | âœ… å·²ç¡®è®¤æ­£ç¡® |
| åˆ†é¡µå¤„ç†       | âœ…       | âœ…         | âœ… å®Œå…¨ä¸€è‡´   |
| é”™è¯¯ç å¤„ç†     | âœ…       | âœ…         | âœ… å®Œå…¨ä¸€è‡´   |
| è¯·æ±‚è¶…æ—¶       | âœ…       | âš ï¸         | âš ï¸ å»ºè®®æ·»åŠ    |
| é‡è¯•æœºåˆ¶       | âœ…       | âŒ         | âš ï¸ å¯é€‰ä¼˜åŒ–   |
| Token é”       | âœ…       | âŒ         | âš ï¸ å»ºè®®æ·»åŠ    |

## æ€»ç»“

### âœ… å·²å®Œæˆ

1. ä¿®å¤äº† tenant_access_token å“åº”å¤„ç†
2. ç¡®è®¤äº† API å‚æ•°åç§°æ­£ç¡®
3. æ‰€æœ‰ä»£ç é€šè¿‡ TypeScript ç¼–è¯‘
4. æ‰€æœ‰ä»£ç é€šè¿‡ Linter æ£€æŸ¥
5. æ‰€æœ‰ä»£ç é€šè¿‡ Prettier æ ¼å¼åŒ–

### âš ï¸ éœ€è¦éªŒè¯

1. tasklist_guids æ˜¯å¦æ”¯æŒå¤šä¸ªï¼ˆå®é™… API è°ƒç”¨æ—¶éªŒè¯ï¼‰
2. å®Œæˆä»»åŠ¡ API çš„å“åº”ç»“æ„ï¼ˆå®é™…ä½¿ç”¨æ—¶éªŒè¯ï¼‰
3. è¯„è®º API çš„å­—æ®µåç§°ï¼ˆå®é™…ä½¿ç”¨æ—¶éªŒè¯ï¼‰

### ğŸš€ å¯é€‰ä¼˜åŒ–

1. æ·»åŠ è¯·æ±‚è¶…æ—¶å¤„ç†ï¼ˆæå‡å¥å£®æ€§ï¼‰
2. æ·»åŠ  Token åˆ·æ–°é”ï¼ˆé˜²æ­¢å¹¶å‘é—®é¢˜ï¼‰
3. æ·»åŠ é‡è¯•æœºåˆ¶ï¼ˆæå‡å®¹é”™æ€§ï¼‰

**å»ºè®®**: å…ˆè¿›è¡Œå®é™…æµ‹è¯•ï¼Œæ ¹æ®æµ‹è¯•ç»“æœå†å†³å®šæ˜¯å¦éœ€è¦æ·»åŠ å¯é€‰ä¼˜åŒ–ã€‚å½“å‰å®ç°å·²ç»ç¬¦åˆ Lark SDK çš„æ ¸å¿ƒè§„èŒƒï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼ğŸ‰
